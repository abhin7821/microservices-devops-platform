pipeline {
    agent any

    environment {
        AWS_REGION = 'us-east-1'
        ECR_REPO = '442122590814.dkr.ecr.us-east-1.amazonaws.com/user-service'
        IMAGE_NAME = 'user-service'
        GIT_REPO = 'https://github.com/abhin7821/microservices-devops-platform.git'
        GIT_CREDENTIALS = 'github-pat'            // GitHub PAT credential ID in Jenkins
        AWS_CREDENTIALS = 'jenkins-ecr-user'      // AWS credential ID
        ARGOCD_SERVER = 'argo-server-url'         // Optional if CLI sync
    }

    stages {

        stage('Checkout') {
            steps {
                echo "üì• Checking out code from GitHub..."
                git branch: 'main',
                    credentialsId: "${GIT_CREDENTIALS}",
                    url: "${GIT_REPO}"
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "üê≥ Building Docker image..."
                sh '''
                    docker build -t $IMAGE_NAME:latest ./app
                '''
            }
        }

        stage('Push to ECR') {
            steps {
                echo "üöÄ Logging into ECR and pushing image..."
                withAWS(credentials: "${AWS_CREDENTIALS}", region: "${AWS_REGION}") {
                    sh '''
                        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REPO
                        docker tag $IMAGE_NAME:latest $ECR_REPO:$BUILD_NUMBER
                        docker push $ECR_REPO:$BUILD_NUMBER
                    '''
                }
            }
        }

        stage('Update Helm Chart Image Tag') {
            steps {
                echo "üìù Updating Helm values.yaml with new image tag..."
                sh '''
                    sed -i "s@tag:.*@tag: $BUILD_NUMBER@" ./helm/user-service/values.yaml
                '''
            }
        }

        stage('Commit & Push Helm Update to GitHub') {
            steps {
                echo "üíæ Committing Helm chart update back to GitHub..."
                withCredentials([string(credentialsId: 'github-pat', variable: 'GIT_PAT')]) {
                    sh '''
                        git config user.email "jenkins@ci.com"
                        git config user.name "Jenkins CI"
                        git add ./helm/user-service/values.yaml
                        git commit -m "Auto-update image tag to $BUILD_NUMBER" || echo "No changes to commit"
                        git push https://$GIT_PAT@github.com/abhin7821/microservices-devops-platform.git main
                    '''
                }
            }
        }

        stage('Trigger ArgoCD Sync') {
            steps {
                echo "üîÑ Triggering ArgoCD sync for user-service..."
                script {
                    try {
                        sh '''
                            if command -v argocd &> /dev/null; then
                                echo "Running ArgoCD sync via CLI..."
                                argocd app sync user-service --grpc-web || true
                            else
                                echo "ArgoCD CLI not installed. Sync will occur automatically via Git webhook."
                            fi
                        '''
                    } catch (err) {
                        echo "‚ö†Ô∏è Warning: ArgoCD sync command failed or not available. Continuing..."
                    }
                }
            }
        }

        stage('Verify Deployment Rollout') {
            steps {
                echo "üïµÔ∏è Checking rollout status..."
                sh '''
                    kubectl rollout status rollout/user-service -n default --timeout=120s || true
                '''
            }
        }
    }

    post {
