pipeline {
    agent any

    environment {
        AWS_REGION = 'us-east-1'
        ECR_REPO = '442122590814.dkr.ecr.us-east-1.amazonaws.com/user-service'
        IMAGE_NAME = 'user-service'
        GIT_CREDENTIALS = 'github-cred'
        AWS_CREDENTIALS = 'jenkins-ecr-user'
        GIT_REPO_URL = 'https://github.com/abhin7821/microservices-devops-platform.git'
        GIT_USER_EMAIL = 'jenkins@ci.com'
        GIT_USER_NAME = 'Jenkins CI'
        PAT_TOKEN = credentials('github-pat')   // Your GitHub Personal Access Token stored in Jenkins
    }

    stages {
        stage('Checkout') {
            steps {
                echo "üì¶ Checking out code from GitHub..."
                git branch: 'main',
                    credentialsId: "${GIT_CREDENTIALS}",
                    url: "${GIT_REPO_URL}"
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "üê≥ Building Docker image..."
                sh 'docker build -t $IMAGE_NAME:latest ./app'
            }
        }

        stage('Push to ECR') {
            steps {
                echo "üì§ Pushing Docker image to ECR..."
                withAWS(credentials: "${AWS_CREDENTIALS}", region: "${AWS_REGION}") {
                    sh '''
                    aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REPO
                    docker tag $IMAGE_NAME:latest $ECR_REPO:$BUILD_NUMBER
                    docker push $ECR_REPO:$BUILD_NUMBER
                    '''
                }
            }
        }

        stage('Update Helm Chart & Push to GitHub') {
            steps {
                echo "üìù Updating Helm values.yaml with new image tag: $BUILD_NUMBER"
                sh '''
                sed -i "s@tag:.*@tag: $BUILD_NUMBER@" ./helm/user-service/values.yaml
                git config user.email "$GIT_USER_EMAIL"
                git config user.name "$GIT_USER_NAME"
                git add ./helm/user-service/values.yaml
                git commit -m "Auto-update image tag to $BUILD_NUMBER"

                # Use Personal Access Token for pushing
                git push https://${PAT_TOKEN}@github.com/abhin7821/microservices-devops-platform.git main
                '''
            }
        }

        stage('Trigger ArgoCD Sync (Rollout Canary)') {
            steps {
                echo "üöÄ Triggering ArgoCD sync..."
                sh '''
                argocd login a6631b6bf18e44aae8fc109756b8a16c-1597380267.us-east-1.elb.amazonaws.com --username admin --password <your-argo-password> --grpc-web
                argocd app sync user-service --grpc-web
                '''
            }
        }

        stage('Wait for Canary Rollout') {
            steps {
                echo "‚è≥ Monitoring canary rollout..."
                sh '''
                kubectl argo rollouts get rollout user-service -n default --watch
                '''
            }
        }
    }

    post {
        success {
            echo "‚úÖ SUCCESS: Canary rollout completed for image tag $BUILD_NUMBER!"
        }
        failure {
            echo "‚ùå FAILURE: Pipeline or rollout failed. Check ArgoCD logs."
            sh 'docker system prune -f'
        }
        always {
            echo "üßπ Cleanup done."
        }
    }
}
